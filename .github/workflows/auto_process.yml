name: AI Photo Assistant & Auto Deploy

on:
  push:
    paths:
      - 'assets/photos/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install Pillow pyyaml requests

      - name: Run AI & Compression
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python <<EOF
          import os, base64, requests, yaml, time
          from PIL import Image

          api_key = os.environ['GEMINI_API_KEY']
          # 使用你 Key 权限内最强的 2.5 版本
          api_url = f"https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key={api_key}"

          photo_dir = 'assets/photos'
          data_file = '_data/descriptions.yml'
          
          if os.path.exists(data_file):
              with open(data_file, 'r', encoding='utf-8') as f:
                  descriptions = yaml.safe_load(f) or {}
          else:
              descriptions = {}

          os.makedirs('_data', exist_ok=True)
          processed_any = False

          for filename in os.listdir(photo_dir):
              # 如果该文件还没有描述，或者描述还是旧的字符串格式，则重新生成
              if filename.lower().endswith(('.jpg', '.jpeg', '.png', '.webp')) and (filename not in descriptions or isinstance(descriptions[filename], str)):
                  try:
                      img_path = os.path.join(photo_dir, filename)
                      img = Image.open(img_path)
                      img.save(img_path, optimize=True, quality=80)
                      
                      with open(img_path, "rb") as image_file:
                          encoded_string = base64.b64encode(image_file.read()).decode('utf-8')

                      # 提示词优化：要求简短、双语、特定格式
                      payload = {
                          "contents": [{
                              "parts": [
                                  {"text": "请为这张摄影作品提供极简描述。第一行中文，第二行英文。每行不超过15个字。风格感性。"},
                                  {"inline_data": {"mime_type": "image/jpeg", "data": encoded_string}}
                              ]
                          }]
                      }
                      
                      response = requests.post(api_url, json=payload)
                      result = response.json()
                      
                      if 'candidates' in result:
                          raw_text = result['candidates'][0]['content']['parts'][0]['text'].strip()
                          lines = [l.strip() for l in raw_text.split('\n') if l.strip()]
                          
                          if len(lines) >= 2:
                              descriptions[filename] = {
                                  "zh": lines[0],
                                  "en": lines[1]
                              }
                              print(f"✅ 双语生成成功: {filename}")
                              processed_any = True
                      else:
                          print(f"❌ API 报错: {result}")
                      
                      time.sleep(2) 
                  except Exception as e:
                      print(f"❌ 错误 {filename}: {e}")

          if processed_any:
              with open(data_file, 'w', encoding='utf-8') as f:
                  yaml.dump(descriptions, f, allow_unicode=True)
          EOF

      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --quiet && git diff --staged --quiet || (git commit -m "AI: Update bilingual short descriptions" && git push)

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
