- name: Run AI & Compression
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python <<EOF
          import os, base64, requests, yaml, time
          from PIL import Image

          api_key = os.environ['GEMINI_API_KEY']
          
          # 1. å…ˆæŽ¢æµ‹ä½ çš„ Key åˆ°åº•èƒ½çœ‹åˆ°å“ªäº›æ¨¡åž‹ (ç”¨äºŽæŽ’æŸ¥ 404)
          list_url = f"https://generativelanguage.googleapis.com/v1/models?key={api_key}"
          try:
              models_resp = requests.get(list_url).json()
              print(f"ðŸ” å½“å‰ Key å¯ç”¨çš„æ¨¡åž‹åˆ—è¡¨: {models_resp}")
          except Exception as e:
              print(f"âŒ æŽ¢æµ‹æ¨¡åž‹å¤±è´¥: {e}")

          # 2. æ ¸å¿ƒ API åœ°å€ (ç¡®ä¿ä½¿ç”¨ v1 æ­£å¼ç‰ˆ)
          # æ³¨æ„ï¼šå¦‚æžœä¸‹é¢ä»ç„¶ 404ï¼Œè¯·æ ¹æ®ä¸Šé¢æ‰“å°å‡ºæ¥çš„åˆ—è¡¨ä¿®æ”¹è¿™é‡Œçš„ gemini-1.5-flash
          # å°† gemini-1.5-flash æ”¹ä¸º gemini-2.5-flash
          api_url = f"https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key={api_key}"

          photo_dir = 'assets/photos'
          data_file = '_data/descriptions.yml'
          
          if os.path.exists(data_file):
              with open(data_file, 'r', encoding='utf-8') as f:
                  descriptions = yaml.safe_load(f) or {}
          else:
              descriptions = {}

          os.makedirs('_data', exist_ok=True)
          processed_any = False

          for filename in os.listdir(photo_dir):
              if filename.lower().endswith(('.jpg', '.jpeg', '.png', '.webp')) and filename not in descriptions:
                  try:
                      img_path = os.path.join(photo_dir, filename)
                      img = Image.open(img_path)
                      img.save(img_path, optimize=True, quality=80)
                      
                      with open(img_path, "rb") as image_file:
                          encoded_string = base64.b64encode(image_file.read()).decode('utf-8')

                      payload = {
                          "contents": [{
                              "parts": [
                                  {"text": "è¯·ç”¨ä¸€å¥è¯æè¿°è¿™å¼ æ‘„å½±ä½œå“çš„æ„å¢ƒï¼Œä¸­æ–‡ï¼Œæ„Ÿæ€§ä¸”æœ‰è¯—æ„ã€‚"},
                                  {"inline_data": {"mime_type": "image/jpeg", "data": encoded_string}}
                              ]
                          }]
                      }
                      
                      response = requests.post(api_url, json=payload)
                      result = response.json()
                      
                      if 'candidates' in result:
                          descriptions[filename] = result['candidates'][0]['content']['parts'][0]['text'].strip()
                          print(f"âœ… æˆåŠŸç”Ÿæˆæè¿°: {filename}")
                          processed_any = True
                      else:
                          # è¿™é‡Œä¼šæ‰“å°å‡ºæœ€è¯¦ç»†çš„é”™è¯¯åŽŸå› 
                          print(f"âŒ API æŠ¥é”™è¯¦æƒ…: {result}")
                      
                      time.sleep(3)
                  except Exception as e:
                      print(f"âŒ ç¨‹åºæ‰§è¡Œé”™è¯¯ {filename}: {e}")

          if processed_any:
              with open(data_file, 'w', encoding='utf-8') as f:
                  yaml.dump(descriptions, f, allow_unicode=True)
          EOF
