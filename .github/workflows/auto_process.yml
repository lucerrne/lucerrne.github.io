name: AI Photo Assistant & Auto Deploy

on:
  push:
    paths:
      - 'assets/photos/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install Pillow pyyaml requests

      - name: Run AI & Smart Compression
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python <<EOF
          import os, base64, requests, yaml, time, random
          from PIL import Image, ImageDraw, ImageFont
          from datetime import datetime

          api_key = os.environ['GEMINI_API_KEY']
          # ä¸¥æ ¼ä¿æŒä½ æä¾›çš„ API URL ç‰ˆæœ¬
          api_url = f"https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key={api_key}"

          photo_dir = 'assets/photos'
          data_file = '_data/descriptions.yml'
          
          # è‡ªå®šä¹‰åå­—
          my_name = "@Lucerrne's Photo"
          # è·å–å½“å‰æ—¶é—´
          current_time = datetime.now().strftime("%Y-%m-%d %H:%M")
          watermark_text = f"{my_name} | {current_time}"
          
          if os.path.exists(data_file):
              with open(data_file, 'r', encoding='utf-8') as f:
                  descriptions = yaml.safe_load(f) or {}
          else:
              descriptions = {}

          os.makedirs('_data', exist_ok=True)
          processed_any = False

          # éå†æ–‡ä»¶å¤¹
          for filename in os.listdir(photo_dir):
              # ä¿®æ”¹é€»è¾‘ï¼šåªè¦æ˜¯å›¾ç‰‡å°±å¤„ç†ï¼Œä¸å†æ£€æŸ¥æ˜¯å¦åœ¨ descriptions ä¸­ï¼Œå®ç°å¼ºåˆ¶é‡å†™
              if filename.lower().endswith(('.jpg', '.jpeg', '.png', '.webp')):
                  try:
                      img_path = os.path.join(photo_dir, filename)
                      img = Image.open(img_path)
                      
                      # 1. å½»åº•æ¸…é™¤ EXIF (é€šè¿‡é‡æ–°åˆ›å»º RGB å›¾åƒå®ç°)
                      clean_img = Image.new("RGB", img.size)
                      if img.mode == "RGBA":
                          clean_img.paste(img, (0, 0), img)
                      else:
                          clean_img.paste(img, (0, 0))
                      
                      # 2. æ™ºèƒ½ç¼©æ”¾ (é™åˆ¶å®½åº¦ 1920pxï¼Œä¿æŒ 75% å‹ç¼©è´¨é‡)
                      if clean_img.width > 1920:
                          ratio = 1920 / float(clean_img.width)
                          new_h = int(float(clean_img.height) * float(ratio))
                          clean_img = clean_img.resize((1920, new_h), Image.Resampling.LANCZOS)
                      
                      # 3. æ·»åŠ åŠ¨æ€éšæœºä½ç½®æ°´å°
                      draw = ImageDraw.Draw(clean_img)
                      font_size = int(clean_img.width * 0.018) # è‡ªé€‚åº”å­—å·
                      try:
                          font = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", font_size)
                      except:
                          font = ImageFont.load_default()
                      
                      # è®¡ç®—æ–‡æ¡ˆå°ºå¯¸
                      text_bbox = draw.textbbox((0, 0), watermark_text, font=font)
                      tw, th = text_bbox[2] - text_bbox[0], text_bbox[3] - text_bbox[1]
                      margin = 35
                      
                      # éšæœºå››ä¸ªè§’è½
                      positions = [
                          (margin, margin),                                      # å·¦ä¸Š
                          (clean_img.width - tw - margin, margin),               # å³ä¸Š
                          (margin, clean_img.height - th - margin),              # å·¦ä¸‹
                          (clean_img.width - tw - margin, clean_img.height - th - margin) # å³ä¸‹
                      ]
                      x, y = random.choice(positions)
                      
                      # ç»˜åˆ¶åŠé€æ˜ç™½è‰²æ–‡å­— (128 ä¸ºåŠé€æ˜)
                      draw.text((x, y), watermark_text, font=font, fill=(255, 255, 255, 128))

                      # 4. å¼ºåˆ¶è¦†ç›–ä¿å­˜ (WebP æ ¼å¼ï¼Œä¿æŒåŸæ–‡ä»¶ååç¼€)
                      clean_img.save(img_path, "WebP", quality=75, optimize=True)
                      print(f"âœ… å¼ºåˆ¶å¤„ç†æˆåŠŸ (å·²å‹ç¼©+éšæœºæ°´å°): {filename}")

                      # 5. è°ƒç”¨ AI ç”Ÿæˆæ–‡æ¡ˆ
                      with open(img_path, "rb") as image_file:
                          encoded_string = base64.b64encode(image_file.read()).decode('utf-8')

                      system_prompt = (
                          "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ‘„å½±è¯„è®ºå®¶ã€‚è¯·ç”¨ä¸€å¥è¯æè¿°è¿™å¼ ä½œå“çš„æ„å¢ƒã€‚"
                          "è¦æ±‚ï¼š1. è¯­è¨€æ„Ÿæ€§ä¸”å¯Œæœ‰è¯—æ„ï¼›2. ç¦æ­¢ä½¿ç”¨ä»»ä½•ç‰¹æ®Šç¬¦å·ï¼ˆå¦‚æ˜Ÿå·*ã€äº•å·#ã€æ‹¬å·ç­‰ï¼‰ï¼›"
                          "3. è¯æ±‡è¦ä¸°å¯Œå¤šæ ·ï¼Œé¿å…ä½¿ç”¨é™ˆè¯æ»¥è°ƒï¼›"
                          "4. ç›´æ¥è¾“å‡ºæ–‡æ¡ˆå†…å®¹ï¼Œä¸è¦è§£é‡Šã€‚"
                      )

                      payload = {
                          "contents": [{
                              "parts": [
                                  {"text": system_prompt},
                                  {"inline_data": {"mime_type": "image/webp", "data": encoded_string}}
                              ]
                          }],
                          "generationConfig": {
                              "temperature": 0.8,
                              "topP": 0.95,
                              "maxOutputTokens": 100
                          }
                      }
                      
                      response = requests.post(api_url, json=payload)
                      result = response.json()
                      
                      if 'candidates' in result:
                          descriptions[filename] = result['candidates'][0]['content']['parts'][0]['text'].strip()
                          print(f"ğŸ“ æ–‡æ¡ˆå·²æ›´æ–°: {filename}")
                          processed_any = True
                      else:
                          print(f"âŒ API æŠ¥é”™è¯¦æƒ…: {result}")
                      
                      time.sleep(2)
                  except Exception as e:
                      print(f"âŒ é”™è¯¯ {filename}: {e}")

          if processed_any:
              with open(data_file, 'w', encoding='utf-8') as f:
                  yaml.dump(descriptions, f, allow_unicode=True)
          EOF
      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: optimize images and updates [skip ci]" && git push)

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
