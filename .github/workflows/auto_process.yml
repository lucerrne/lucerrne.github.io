name: AI Photo Assistant & Auto Deploy

on:
  push:
    paths:
      - 'assets/photos/**' # 只有当 photos 文件夹有变动时才触发

# 核心：设置并发策略，确保同一时间只有一个任务在跑，旧的会自动停止而不报错
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 允许 AI 写回描述
      pages: write    # 允许触发部署
      id-token: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install google-generativeai Pillow pyyaml

      - name: Run AI & Compression
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python <<EOF
          import os
          import google.generativeai as genai
          from PIL import Image
          import yaml

          # 配置 AI
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          model = genai.GenerativeModel('gemini-1.5-flash-latest')

          photo_dir = 'assets/photos'
          data_file = '_data/descriptions.yml'
          
          # 读取已有数据
          if os.path.exists(data_file):
              with open(data_file, 'r', encoding='utf-8') as f:
                  descriptions = yaml.safe_load(f) or {}
          else:
              descriptions = {}

          # 确保 _data 目录存在
          os.makedirs('_data', exist_ok=True)

          # 遍历照片
          for filename in os.listdir(photo_dir):
              if filename.lower().endswith(('.jpg', '.jpeg', '.png', '.webp')) and filename not in descriptions:
                  try:
                      img_path = os.path.join(photo_dir, filename)
                      
                      # 1. AI 识图
                      img = Image.open(img_path)
                      response = model.generate_content(["请用一句话描述这张摄影作品的意境，中文，感性且有诗意。", img])
                      descriptions[filename] = response.text.strip()
                      print(f"Generated description for {filename}")

                      # 2. 压缩图片 (原位替换以节省空间)
                      img.save(img_path, optimize=True, quality=80)
                  except Exception as e:
                      print(f"Error processing {filename}: {e}")

          # 保存描述
          with open(data_file, 'w', encoding='utf-8') as f:
              yaml.dump(descriptions, f, allow_unicode=True)
          EOF

      - name: Commit and Push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --quiet && git diff --staged --quiet || (git commit -m "AI: Update descriptions and compress images" && git push)

      # 关键步骤：在 AI 工作完成后，手动触发 GitHub Pages 的部署
      - name: Trigger GitHub Pages Deploy
        uses: actions/deploy-pages@v4
        if: success()
